# FROM ubuntu:20.04

# ARG DEBIAN_FRONTEND=noninteractive

# # Install packages: Suricata, SSH, syslog, net-tools
# RUN apt-get update && \
#     apt-get install -y --no-install-recommends \
#       suricata \
#       suricata-update \
#       openssh-server \
#       rsyslog \
#       net-tools && \
#     suricata-update && \
#     rm -rf /var/lib/apt/lists/*

# # create log and run directories
# RUN mkdir -p /var/log/suricata /var/run/sshd && \
#     sed -i 's/^#PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
#     sed -i 's/^#PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
#     echo 'root:root' | chpasswd

# EXPOSE 514/udp 22/tcp

# # launch ssh only
# CMD ["/usr/sbin/sshd", "-D"]

# # launch sshd in the background, then run Suricata on eth0
# # ENTRYPOINT ["/bin/bash", "-c", "/usr/sbin/sshd && exec suricata -c /etc/suricata/suricata.yaml -i eth0"]

# # launch sshd in the foreground and run Suricata on any interface
# # ENTRYPOINT ["/bin/bash", "-c", "/usr/sbin/sshd -D & exec suricata -c /etc/suricata/suricata.yaml -i any"]



FROM ubuntu:24.04

# Noninteractive mode for apt
ENV DEBIAN_FRONTEND=noninteractive

# Update and install basic packages
RUN apt-get update && apt-get install -y \
    sudo \
    openssh-server \
    net-tools \
    iproute2 \
    iputils-ping \
    rsyslog \
    curl \
    wget \
    gnupg \
    software-properties-common \
    nano \
    tcpdump
    # lsb-release
    # systemctl

# Enable IP forwarding
RUN echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

# Install Suricata (from OISF PPA)
RUN add-apt-repository ppa:oisf/suricata-stable -y && \
    apt-get update && \
    apt-get install -y suricata

# SSH setup
RUN mkdir /var/run/sshd && \
    echo 'root:toor' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/Port 22/Port 2222/' /etc/ssh/sshd_config

# Logging
RUN touch /var/log/suricata.log && \
    ln -s /var/log/suricata.log /var/log/suricata.log.link

# Suricata config: allow ping, alert on Nmap
RUN mkdir -p /etc/suricata/rules && echo 'alert tcp any any -> any any (msg:"Nmap Scan Detected"; flags:S,12; threshold:type limit, track by_src, count 1, seconds 60; classtype:attempted-recon; sid:1000001; rev:1;)' > /etc/suricata/rules/local.rules

# Make sure Suricata uses local.rules
RUN sed -i 's|default-rule-path: /etc/suricata/rules|default-rule-path: /etc/suricata/rules|' /etc/suricata/suricata.yaml && \
    sed -i 's| - suricata-rules| - local.rules|' /etc/suricata/suricata.yaml

# Expose SSH port
EXPOSE 2222

# Run services
CMD ["sh", "-c", "sysctl -w net.ipv4.ip_forward=1 && service rsyslog start && service ssh start && suricata -i eth1 -c /etc/suricata/suricata.yaml -D && tail -f /var/log/suricata/fast.log"]
