# 1) Base image
FROM ubuntu:16.04

# 2) Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# 3) Enable source repos so we can apt-get build-dep
RUN sed -i 's|^# deb-src|deb-src|' /etc/apt/sources.list

# 4) Update & install build-deps + runtime deps
RUN apt-get update && \
    # pull in *all* distro build-deps for Samba
    apt-get build-dep -y samba && \
    # plus runtime/tools we need
    apt-get install -y --no-install-recommends \
      build-essential \
      python \
      ca-certificates \
      wget \
      git \
      openssh-server \
      rsyslog \
      net-tools && \
    # ensure /usr/bin/python â†’ Python 2 (for waf)
    ln -sf /usr/bin/python2 /usr/bin/python && \
    # cleanup
    apt-get clean && rm -rf /var/lib/apt/lists/*

# 5) SSH setup (root password = toor)
RUN mkdir /var/run/sshd && \
    echo 'root:toor' | chpasswd && \
    sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

# 6) Grab, compile, install Samba 4.5.9
WORKDIR /opt
RUN wget https://download.samba.org/pub/samba/stable/samba-4.5.9.tar.gz && \
    tar xzf samba-4.5.9.tar.gz && \
    cd samba-4.5.9 && \
    ./configure && \
    make -j"$(nproc)" && \
    make install && \
    cd .. && rm -rf samba-4.5.9*

# 7) Put Samba binaries in PATH
ENV PATH="/usr/local/samba/sbin:/usr/local/samba/bin:${PATH}"

# 8) Add a minimal smb.conf
RUN mkdir -p /usr/local/samba/etc
COPY smb.conf /usr/local/samba/etc/smb.conf

# 9) Expose SSH + SMB
EXPOSE 22 139 445

# 10) Launch services properly
CMD ["/bin/bash", "-c", "\
    service rsyslog start && \
    service ssh restart && \
    exec /usr/local/samba/sbin/smbd -F --no-process-group\
"]
